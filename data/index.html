<!DOCTYPE html>

<html>
    <head>
        <title>Remote Activation Scheduler by Adi Nugroho</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
    </head>

    <body style="margin:0; min-height:100vh; background: linear-gradient(to bottom,rgb(50,50,50),rgb(30,30,30)); font-family: monospace; color: rgb(220,220,220); padding:16px;">
        <!-- Top content / status -->
        <div style="text-align:center; margin-bottom:24px;">
            <h3 style="margin:0;">Control Panel</h3>
            <div style="color:rgb(160,160,160); font-size:14px;">Device Online</div>
        </div>
        
        <!-- Schedule Panel Template -->
        <div id="schedule_template" class="Schedule" data-mode="" data-date="" data-startTime="" data-duration="" data-interval="" style="display:none; border:1px solid rgb(80,80,80); background: rgb(10,10,10); padding:10px; margin-bottom:10px;">  
            <div style="margin-bottom:6px;">Mode: <b class="Mode"></b></div>
            <div style="margin-bottom:6px;">Date: <b class="Date"></b></div>
            <div style="margin-bottom:6px;">Time: <b class="Time"></b></div>
            <div id="duration_placeholder" style="display:block; margin-bottom:8px;">Duration: <b class="Duration"></b></div>
            <div id="interval_placeholder" style="display:none; margin-bottom:8px;">Interval: <b class="Interval"></b></div>

            <!-- Confirmation panel -->
            <details>
                <summary style="color:rgb(255,120,120); cursor:pointer;">
                    Delete Schedule
                </summary>
                <div style="margin-top:8px; padding:8px; background: rgb(40,0,0); border:1px solid rgb(120,60,60);">
                    <div style="margin-bottom:8px;">
                        Confirm deletion?
                    </div>
                    <button id="delete_schedule_button" onclick="DeleteSchedule(this)" style="width:100%; padding:8px; background: rgb(120,0,0); color: rgb(255,200,200); border:1px solid rgb(180,80,80); font-family: monospace;">
                        CONFIRM DELETE
                    </button>
                </div>
            </details>
        </div>

        <!-- Add Schedule (safe by placement) -->
        <button id="add_schedule_button" onclick="OpenOverlay()" style="display:block; margin:0 auto; padding:12px; background: rgb(30,30,30); color: rgb(0,200,255); border:1px solid rgb(80,80,80); font-size:16px;">
            + Add Schedule
        </button>
        
        <!-- Schedule Container -->
        <div style="text-align:center; font-size:16px; margin-top:10px; margin-bottom:10px;">SCHEDULES</div> 
        <div id="schedule_container" style="max-width:400px; margin:0 auto; background: rgb(20,20,20); border:1px solid rgb(90,90,90); padding:12px; box-sizing:border-box;"></div>

        <!-- Overlay Panel -->
        <div id="overlay" style="display:none; position:fixed; top:0; left:0; width:100vw; overflow-y:auto; background: rgba(0,0,0,0.5); z-index:20;">
            <div style="max-width:300px; margin:0vh auto; background: rgb(20,20,20); border:1px solid rgb(90,90,90); padding:10px; font-family: monospace;">
                <div style="text-align:center; margin-bottom:20px;">
                    ADD SCHEDULE
                </div>

                <form id="schedule_form" onsubmit="return OnSubmitForm();">   <!-- prevent browser from reloading -->
                    <!-- Mode -->
                    <div style="margin-bottom:5px;">Mode</div>
                    <select id="input_mode" onChange="ToggleMode()" style="width:50%; padding:10px;">
                        <option value="0">Once</option>     
                        <option value="1">Repeat</option>
                        <option value="2">Always Active</option>
                    </select>

                    <!-- Start Date -->
                    <div style="margin-top:20px; margin-bottom:5px;">Date</div>
                    <input id="input_date" type="date" required="true" style="width:90%; padding:8px;">

                    <!-- Start time -->
                    <div style="margin-top:20px; margin-bottom:5px;">Start Time</div>
                    <input id="input_time" type="time" required="true" style="width:90%; padding:8px;">

                    <!-- Duration -->
                    <div style="margin-top:20px; margin-bottom:20px;">
                        <!-- custom validity wont be cleared automatically, once triggered will always occur. clear it manually outside of submit -->
                        <div style="margin-top:20px; margin-bottom:5px;">Duration (Days)</div>
                        <input id="input_duration_day" type="number" min="0" required="true" disabled="false" oninput="ClearCustomValidity()" style="width:90%; padding:8px;">
                        <div style="margin-top:5px; margin-bottom:5px;">Duration (Hours)</div>
                        <input id="input_duration_hour" type="number" min="0" required="true" disabled="false" oninput="ClearCustomValidity()" style="width:90%; padding:8px;">
                        <div style="margin-top:5px; margin-bottom:5px;">Duration (Minutes)</div>
                        <input id="input_duration_minute" type="number" min="0" required="true" disabled="false" oninput="ClearCustomValidity()" style="width:90%; padding:8px;">
                        <div style="margin-top:5px; margin-bottom:5px;">Duration (Seconds)</div>
                        <input id="input_duration_second" type="number" min="0" required="true" disabled="false" oninput="ClearCustomValidity()" style="width:90%; padding:8px;">
                    </div>

                    <!-- Interval -->
                    <div id="interval" style="margin-top:20px; margin-bottom:20px;">
                        <div style="margin-top:20px; margin-bottom:5px;">Interval</div>
                        <table style="width:100%; border-collapse:collapse;">
                            <tr>
                                <td style="width:50%;">
                                    <input id="input_interval" type="number" min="1" required="true" disabled="true" style="width:80%; padding:10px;">
                                </td>
                                <td style="width:50%;">
                                    <select id="input_interval_unit" disabled="true" style="width:80%; padding:10px;">
                                        <option value="0">Minutes</option>
                                        <option value="1">Hours</option>
                                        <option value="2">Days</option>
                                        <option value="3">Weeks</option>
                                    </select>
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div style="margin-top:30px; margin-bottom:30px;"></div>

                    <!-- Confirm Buttons -->
                    <button type="submit" style="background-color:green; color:white; width:100%; padding:10px; margin-bottom:20px;">
                        CONFIRM
                    </button>
                </form>

                <!-- Cancel Button -->
                <button onclick="CloseOverlay()" style="background-color:red; color:white; width:100%; padding:10px;">
                    CANCEL
                </button>
            </div>
        </div>




        <!-- Script Section (Javascript) -->
        <script>
            function fixVh()    // fix mobile height issue : remove 100vh at overlay and use windows.innerHeight instead
            {
                document.getElementById("overlay").style.height = window.innerHeight + "px";
            }
            window.addEventListener("resize", fixVh);
            window.addEventListener("orientationchange", fixVh);
            fixVh();


            function OpenOverlay()
            {
                document.getElementById("overlay").style.display = "block";
            }


            function CloseOverlay()
            {
                document.getElementById("overlay").style.display = "none";
            }


            function ToggleMode()
            {
                const mode = document.getElementById("input_mode").value;
                const inputInterval = document.getElementById("input_interval");
                const inputIntervalUnit = document.getElementById("input_interval_unit");
                const scheduleForm = document.getElementById("schedule_form");      // only document got .getElemetById()
                const durationDay = scheduleForm.elements["input_duration_day"];    // only form got .elements
                const durationHour = scheduleForm.elements["input_duration_hour"];
                const durationMinute = scheduleForm.elements["input_duration_minute"];
                const durationSecond = scheduleForm.elements["input_duration_second"];
                // 0 (Once), 1 (Repeat), 2 (Always Active)
                switch (mode)
                {
                    case "0":
                        inputInterval.disabled = true;
                        inputIntervalUnit.disabled = true;
                        durationDay.required = true;
                        durationDay.disabled = false;
                        durationHour.required = true;
                        durationHour.disabled = false;
                        durationMinute.required = true;
                        durationMinute.disabled = false;
                        durationSecond.required = true;
                        durationSecond.disabled = false;
                        break;
                    case "1": 
                        inputInterval.disabled = false;
                        inputIntervalUnit.disabled = false;
                        durationDay.required = true;
                        durationDay.disabled = false;
                        durationHour.required = true;
                        durationHour.disabled = false;
                        durationMinute.required = true;
                        durationMinute.disabled = false;
                        durationSecond.required = true;
                        durationSecond.disabled = false;
                        break;
                    case "2": 
                        inputInterval.disabled = true;
                        inputIntervalUnit.disabled = true;
                        durationDay.required = false;
                        durationDay.disabled = true;
                        durationHour.required = false;
                        durationHour.disabled = true;
                        durationMinute.required = false;
                        durationMinute.disabled = true;
                        durationSecond.required = false;
                        durationSecond.disabled = true;
                        break;
                    default:
                        console.log("ToogleMode: invalid mode!");
                }
            }


            function OnSubmitForm()
            {
                const scheduleForm = document.getElementById("schedule_form");
                const days = Number(scheduleForm.elements["input_duration_day"].value);
                const hours = Number(scheduleForm.elements["input_duration_hour"].value);
                const minutes = Number(scheduleForm.elements["input_duration_minute"].value);
                const seconds = Number(scheduleForm.elements["input_duration_second"].value);
                const durationTotal = ((days * 24 + hours) * 60 + minutes) * 60 + seconds;  
                const scheduleObj = {
                    id: Date.now().toString(),
                    mode: scheduleForm.elements["input_mode"].value,
                    date: scheduleForm.elements["input_date"].value,
                    time: scheduleForm.elements["input_time"].value,
                    duration: durationTotal.toString(),
                    durationDay: days.toString(),
                    durationHour: hours.toString(),
                    durationMinute: minutes.toString(),
                    durationSecond: seconds.toString(),
                    interval: scheduleForm.elements["input_interval"].value,
                    intervalUnit: scheduleForm.elements["input_interval_unit"].value
                };
                if (scheduleObj.durationDay === "0" && scheduleObj.durationHour === "0" && scheduleObj.durationMinute === "0" && scheduleObj.durationSecond === "0")
                {
                    scheduleForm.elements["input_duration_second"].setCustomValidity("Duration Must Be Greater then 0 Second");
                }
                if(!scheduleForm.checkValidity())
                {
                    scheduleForm.reportValidity(); 
                    return false;
                } 
                CloseOverlay();
                SendSchedule(scheduleObj);
                ReceiveSchedule();
                return false;
            }


            function ClearCustomValidity()
            {
                document.getElementById("input_duration_second").setCustomValidity("");
            }


            function DisplaySchedule(scheduleObj)
            {
                // reference to containers
                const container = document.getElementById("schedule_container");
                const panel = document.getElementById("schedule_template");
                const clone = panel.cloneNode(true);
                const modeMap = {
                    "0": "Once",
                    "1": "Repeat",
                    "2": "Always Active"
                };
                const intervalUnitMap = {
                    "0": "Minutes",
                    "1": "Hours",
                    "2": "Days",
                    "3": "Weeks"
                }
                clone.querySelector(".Mode").innerText = modeMap[scheduleObj.mode] || "Unknown";
                switch (scheduleObj.mode)
                {
                    case "0":
                        clone.querySelector("#duration_placeholder").style.display = "block";
                        clone.querySelector("#interval_placeholder").style.display = "none";
                        clone.querySelector(".Duration").innerText = scheduleObj.durationDay + " Days, " + scheduleObj.durationHour + " Hours, " + scheduleObj.durationMinute + " Minutes, " + scheduleObj.durationSecond + " Seconds";
                        break;
                    case "1": 
                        clone.querySelector("#duration_placeholder").style.display = "block";
                        clone.querySelector("#interval_placeholder").style.display = "block";
                        clone.querySelector(".Duration").innerText = scheduleObj.durationDay + " Days, " + scheduleObj.durationHour + " Hours, " + scheduleObj.durationMinute + " Minutes, " + scheduleObj.durationSecond + " Seconds";
                        clone.querySelector(".Interval").innerText = scheduleObj.interval + " " + (intervalUnitMap[scheduleObj.intervalUnit] || "Unknown");
                        break;
                    case "2":
                        clone.querySelector("#duration_placeholder").style.display = "none";
                        clone.querySelector("#interval_placeholder").style.display = "none";
                        break;
                    default: 
                        console.log("AddSchedule: invalid mode!");
                }
                clone.querySelector(".Date").innerText = scheduleObj.date;
                clone.querySelector(".Time").innerText = scheduleObj.time
                clone.style.display = "block";
                clone.id = "schedule_panel";
                container.appendChild(clone);
            }


            function SendSchedule(scheduleObj)
            {
                fetch("/upload", {
                    method: 'POST',
                    headers: {
                        'content-type': 'application/json'
                    },
                    body: JSON.stringify(scheduleObj)
                }).catch(error => console.error("Error: ", error));
            }


            function ReceiveSchedule()
            {
                fetch("/update").then(response => response.text()).then(scheduleData => {
                    const splittedData = scheduleData.split("\n");
                    const filteredData = splittedData.filter(data => data.trim() !== "");
                    const scheduleArray = filteredData.map(data => {
                        try {
                            return JSON.parse(data);
                        }
                        catch (error) {
                            console.error("Check:", data);
                            return null;
                        }
                    })
                    const container = document.getElementById("schedule_container");
                    container.innerHTML = "";   // delete all schedule panels
                    scheduleArray.forEach(schedule => {
                        DisplaySchedule(schedule);
                    })
                });
            }


            function DeleteSchedule(button)
            {
                const schedulePanel = button.closest(".Schedule");
                const scheduleId = button.closest(".Schedule").id;
                console.log("ID: ", scheduleId);
                fetch("/upload", {
                    method: 'POST',
                    headers: {
                        'content-type': 'application/json'
                    },
                    body: JSON.stringify(scheduleId)
                }).catch(error => console.error("Error: ", error));
                schedulePanel.remove();
            }
        </script>
    </body>
</html>
